---
id: 1440
title: Высокая доступность SMA
date: 2014-07-30T20:37:15+00:00
author: rootilo
layout: post
guid: http://4c74356b41.com/post1440
permalink: /post1440
categories:
  - Azure Pack
  - Virtualization and Cloud
tags:
  - Copypaste
  - Guide
  - Service Management Automation
  - SMA
---
**Описание архитектуры**  

<a href="http://4c74356b41.com/wp-content/uploads/2016/02/sma-ha-00.png" rel="attachment wp-att-5342"><img src="http://4c74356b41.com/wp-content/uploads/2016/02/sma-ha-00-250x300.png" alt="sma-ha-00" width="250" height="300" /></a>
  
Без понимания архитектуры нет смысла в дальнейшем разговоре, потому приступим.

**Web Service**  
  
Принимает запросы по http, &#8220;общается&#8221; с базой данных;
  
Возвращает данные &#8220;клиенту&#8221;.

**Runbook Worker**  
  
Запрашивает у базы данных информацию о заданиях;
  
Исполняет задания;
  
Возвращает в базу данных полученные данные.

**SQL база данных**  
  
Хранит всю информацию SMA - задания, переменные, runbook&#8217;и, данные о заданиях и результаты выполнения заданий.

**&#8220;Клиент&#8221;**  
  
Любая &#8220;программа&#8221;, которая передает данные в SMA, например SMA PowerShell модуль или WAPack Портал Администраторов.

Необходимо сделать первые три компонента высокодоступными и эластичными.

**Высокая доступность компонента &#8220;Web Service&#8221;**  
  
Данный компонент является &#8220;обычным&#8221; веб сервисом. Для обеспечения высокой доступности необходимо использовать технологию Network Load Balancing. Поскольку этот сервис &#8220;stateless&#8221; никаких сложностей с этим возникнуть не должно. При необходимости новые ноды можно добавить или убрать, Microsoft рекомендует 3 ноды.

**Высокая доступность компонента &#8220;Runbook Worker&#8221;**  
  
С данным компонентом все немного сложнее, этот компонент не совсем &#8220;stateless&#8221;. Каждый Runbook Worker отвечает за определенные задания в SMA. Распределением заданий между worker&#8217;ами занимается &#8220;Runbook Worker Deployment&#8221;.
  
Для создания новых worker&#8217;ов необходимо использование командлета [New-SmaRunbookWorkerDeployment](http://technet.microsoft.com/en-us/library/dn502567(v=sc.20).aspx). Но нельзя вносить изменения пока какой-либо воркер выполняет задания, таким образом, изменение конфигурации worker&#8217;ов возможно только с полной остановкой сервиса. Заменить worker&#8217;а можно без остановки сервера. Если, по каким-либо причинам, worker не может выолнять задания, Вам необходимо его заменить.
  
У вас всего 2 варианта
  
1. Удалить данного worker&#8217;а и добавить новый вместо него, но для этого необходимо останавливать сервис;
  
2. Создать новую виртуальную машину с таким же именем (естественно не у виртуальной машины, а у операционной системы) и установить на неё роль &#8220;SMA Worker&#8221;. Перед этим убедитесь что виртуальная машина, которую Вы заменили не включится. Потому что в этом случае у Вас могут возникнуть проблемы (задания выполняются дважды, например). SMA отслеживает worker&#8217;ов только по имени хоста, таким образом замена SMA worker&#8217;а, задача &#8220;тривиальная&#8221; и не требует остановки сервиса.
  
Рекомендация Microsoft&#8217;а - 3 виртуальные машины с ролью SMA Worker. Вы можете использовать те же  виртуальные машины что и для компонента &#8220;Web Service&#8221;.

**Высокая доступность компонента &#8220;SQL база данных&#8221;**  
  
Все довольно просто, SQL Always On или SQL Clustering.